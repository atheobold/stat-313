---
title: "Small Group Collaboration - Session 7"
date: "November 5, 2020"
output: ioslides_presentation
---

<style type="text/css">
slides > slide:not(.nobackground):after {
  content: '';
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      fig.width = 4, 
                      fig.height = 4, 
                      message = FALSE)
library(tidyverse)
library(openintro)
library(gridExtra)
library(moderndive)
library(infer)
library(gapminder)

income <- read_csv("data/income_per_person_gdppercapita_ppp_inflation_adjusted.csv") %>% 
  pivot_longer(-country, names_to = "year", values_to = "income")

math <- read_csv("data/math_achievement_8th_grade.csv") %>% 
  pivot_longer(-country, names_to = "year", values_to = "grade_8_math_score")

income_math <- income %>% 
  left_join(math, by = c("country", "year")) %>% 
  filter(!is.na(grade_8_math_score), 
         year == 2007, 
         income < 90000, ## Removing Kuwait and Qatar
         country != "Bahrain", 
         country != "Oman", 
         country != "Saudi Arabia")  

obs_slope <- income_math %>% 
  specify(grade_8_math_score ~ income) %>% 
  calculate(stat = "slope")

```

## Data 

These data come from the Gapminder Foundation, an organization interested in 
increasing the use and understanding of statistics and other information about
social, economic and environmental development at local, national and global
levels.

- Math Achievement -- Average score in the international TIMSS test for children 
in the 8th grade 
- Income -- Gross domestic product per person adjusted for differences in
purchasing power (in 2011 international dollars)

We will be analyzing data form 42 countries from across the world from 2007. 

## Exploratory Visualization 

```{r, echo = FALSE, fig.width=8}
raw <- income_math %>% 
  ggplot(aes(x = income, y = grade_8_math_score)) + 
  geom_point() + 
  labs(x = "Income (GDP per Person)", 
       y = "8th Grade TIMSS Average Score")

smooth <- income_math %>% 
  ggplot(aes(x = income, y = grade_8_math_score)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  labs(x = "Income (GDP per Person)", 
       y = "")

grid.arrange(raw, smooth, nrow = 1)
```

## Fitting a Linear Regression 

```{r}
income_math_lm <- lm(grade_8_math_score ~ income, data = income_math)
get_regression_table(income_math_lm)
```

</br> 

- How would you interpret the coefficient on `income`? 
- What does the `std_error` column represent?  
- How is the `statistic` for `income` calculated?  

## Model Conditions 

```{r, echo = FALSE, fig.width=8}
line <- income_math_lm %>% 
  ggplot(aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed")

norm <- income_math_lm  %>% 
  ggplot(aes(x = .resid)) +
  geom_histogram(bins = 8)

grid.arrange(line, norm, nrow = 1)
```

What decisions would you reach about the model conditions? 

## Hypothesis Test 

- What are the hypothesis for testing for a linear relationship between income 
and grade 8 math scores?  

- What population parameter are we interested in making inference about?

## Permutation Distribution 

- What steps would be used to create the null distribution below?  

```{r, echo = FALSE, fig.align='center', fig.width=6}
null <- income_math %>% 
  specify(grade_8_math_score ~ income) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "slope") 

null %>% 
  visualize() 
```

## Obtaining a p-value

- Given the distribution of permuted slopes, what information do you need to 
calculate the p-value for the hypothesis test? 

- What $\alpha$ would you choose for the test? Why? 

- Given the p-value below, what decision would you make regarding your hypotheses? 

- What would you conclude about the relationship? 

</br> 
<center>
```{r, echo = FALSE}
get_p_value(null, obs_stat = obs_slope, direction = "two-sided")
```

## Interpretting a p-value 

The p-value above gives the following warning: 

`Warning message: Please be cautious in reporting a p-value of 0. This result is an approximation based on the number of reps chosen in the generate() step.`

</br> 

- What does this mean? 

- For a distribution that used 1,000 reps, how would you interpret a p-value of 0? 

- How would you change this interpretation to use a probability statement instead?

## Confidence Intervals & p-values  

</br> 
</br> 
<center> 

Given the decision you reached for the hypothesis test, what range of values 
do you think are plausible for $\beta_1$? Why? 

<!-- ## Boostrap Distribution -->

<!-- - What do each of the values plotted in the bootstrap distribution represent?   -->

<!-- - Where is the bootstrap distribution centered? Why?  -->

<!-- ```{r, echo = FALSE, fig.align='center', fig.width=6} -->
<!-- bootstrap <- income_math %>%  -->
<!--   specify(grade_8_math_score ~ income) %>%  -->
<!--   generate(reps = 1000, type = "bootstrap") %>%  -->
<!--   calculate(stat = "slope")  -->

<!-- bootstrap %>%  -->
<!--   visualize() +  -->
<!--   labs(x = "Re-sampled Slope Estimate") -->

<!-- ``` -->

<!-- ## Calculating a Confidence Interval  -->

<!-- </br>  -->

<!-- - We have three methods for calculating a confidence interval, what are they?  -->
<!--   * What are the differences between the three methods?  -->
<!--   * Which would you choose?   -->

<!-- ## Comparing Confidence Intervals  -->

<!-- <div class="columns-2"> -->

<!-- ```{r, echo = FALSE, fig.height=3.5} -->
<!-- percentile_ci <- get_confidence_interval(bootstrap, level = 0.95) -->

<!-- se_ci <- get_confidence_interval(bootstrap, level = 0.95,  -->
<!--                                  type = "se", point_estimate = obs_slope) -->

<!-- t_ci <- get_regression_table(income_math_lm) %>% -->
<!--     filter(term == "income") %>%  -->
<!--   select(lower_ci, upper_ci) -->

<!-- confidence_intervals <- rbind(percentile_ci,  -->
<!--                               se_ci,  -->
<!--                               t_ci) %>%  -->
<!--   mutate(type = c("Percentile", "SE", "Theoretical")) %>%  -->
<!--   select(type, lower_ci, upper_ci) -->

<!-- confidence_intervals -->

<!-- visualize(bootstrap) +  -->
<!--   labs(x = "Re-sampled Slope Estimate",  -->
<!--        title = "Bootstrap Distribution",  -->
<!--        color = "Legend") + -->
<!--   shade_confidence_interval(endpoints = percentile_ci, fill = NULL,  -->
<!--                             linetype = "solid", color = "red") +  -->
<!--   shade_confidence_interval(endpoints = se_ci, fill = NULL,  -->
<!--                             linetype = "dashed", color = "blue") + -->
<!--   shade_confidence_interval(endpoints = t_ci, fill = NULL,  -->
<!--                             linetype = "dotted", color = "black") -->

<!-- # scale_color_manual(name = "CI", -->
<!-- # values = c( "Percentile" = "blue", "SE" = "red", "t-based" = "orange"), -->
<!-- # labels = c("Percentile", "SE", "t-based")) -->

<!-- ``` -->

<!-- <center>  -->
<!-- </br>  -->
<!-- </br>  -->

<!-- What are the differences between the three methods?  -->

<!-- Do you believe certain methods are "better" than others in this case?   -->

<!-- ## Interpreting a Confidence Interval  -->

<!-- Let's assume you chose the percentile method to calculate your confidence  -->
<!-- interval (shown below).  -->

<!-- <center> -->
<!-- ```{r, echo = FALSE} -->
<!-- percentile_ci -->
<!-- ``` -->
<!-- </center> -->

<!-- </br>  -->

<!-- - What value are we 95% confident is contained in the interval?   -->

<!-- - How then would you interpret this confidence interval?   -->

<!-- - What do we mean when we say we're "95% confident"?  -->

## Code Used in this Session 

- Visualizations 

```{r, eval = FALSE}
raw <- income_math %>% 
  ggplot(aes(x = income, y = grade_8_math_score)) + 
  geom_point() + 
  labs(x = "Income (GDP per Person)", 
       y = "8th Grade TIMSS Average Score")

smooth <- income_math %>% 
  ggplot(aes(x = income, y = grade_8_math_score)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  labs(x = "Income (GDP per Person)", 
       y = "")
```

## Model Conditions -- Code

```{r, eval = FALSE}
line <- income_math_lm %>% 
  ggplot(aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_hline(yintercept = 0, 
             color = "red", 
             linetype = "dashed")

norm <- income_math_lm  %>% 
  ggplot(aes(x = .resid)) +
  geom_histogram(bins = 8)

```

## Null Distribution -- Code

```{r, eval = FALSE}
null <- income_math %>% 
  specify(grade_8_math_score ~ income) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "slope") 

null %>% 
  visualize() 
```

## p-value -- Code

```{r, eval = FALSE}

obs_slope <- income_math %>% 
  specify(grade_8_math_score ~ income) %>% 
  calculate(stat = "slope")

get_p_value(null, 
            obs_stat = obs_slope, 
            direction = "two-sided")
```

