---
title: "Obtaining & Interpreting p-values"
date: "November 9, 2021"
author: "Dr. Allison Theobold"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["xaringan-themer.css", "slide-style.css"]
    nature:
      highlightStyle: solarized-light
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>
---


```{r, echo = FALSE, message = FALSE, warning = FALSE}
# R options
options(
  htmltools.dir.version = FALSE,
  tibble.width = 65,
  width = 65
  )

# figure height, width, dpi
knitr::opts_chunk$set(fig.width = 8, 
                      fig.asp = 0.618,
                      out.width = "60%",
                      dpi = 300, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.align = "center",
                      echo = FALSE)

# fontawesome
htmltools::tagList(rmarkdown::html_dependency_font_awesome())

# magick
dev.off <- function(){
  invisible(grDevices::dev.off())
}

# xaringanExtra
library(xaringanExtra)
xaringanExtra::use_panelset()

library(emo)
library(tidyverse)
library(openintro)
library(flair)
library(palmerpenguins)
library(broom)
library(gridExtra)
library(kableExtra)
library(moderndive)
library(infer)
library(scales)
library(ggridges)

options(show.signif.stars = FALSE)
```

```{r set-theme, include = FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color      = "#b76352", # mango
  secondary_color    = "#34605f", # bayberry
  header_font_google = google_font("Raleway"),
  text_font_google   = google_font("Raleway", "300", "300i"),
  code_font_google   = google_font("Source Code Pro"),
  header_color = "#793540", #rhubarb
  white_color = "#F5F5F5", # lightest color
  black_color = "#36454F", # darkest color
  text_font_size = "30px", 
  link_color = "#696969" #grey
)
```

```{r data}
coaches <- read_csv("data/cu_csu_coaches.csv")
```

```{r bootstraps, cache = TRUE}
null <- coaches %>%
  filter(`Total Pay & Benefits` != 0) %>% 
  specify(response = `Total Pay & Benefits`, explanatory = Agency) %>% 
  hypothesise(null = "independence") %>% 
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in medians", 
            order = c("University of California", "California State University")
  )

obs_stat <- coaches %>%
  filter(`Total Pay & Benefits` != 0) %>% 
  specify(response = `Total Pay & Benefits`, explanatory = Agency) %>% 
  calculate(stat = "diff in medians", 
            order = c("University of California", "California State University")
  )
  
p_value <- get_p_value(null, obs_stat = obs_stat, direction = "both")  
```

class: center, middle, inverse

.huge[p-value]

.larger[.pink[Goal:]] .large[Summarize how likely / unlikely the observed statistic is, if the null hypothesis is true.]

---

class: center, middle

.larger[.hand[How do I know what is likely to happen if the null is true?]] 

--

.larger[.bayberry[Permuting!]]

---

class: center, inverse

.larger[Statistic: difference in medians]

```{r}
coaches %>%
  filter(`Total Pay & Benefits` != 0) %>% 
  ggplot(mapping = aes(y = Agency, x = `Total Pay & Benefits`, 
                       fill = Agency)) + 
  geom_density_ridges(scale = 1) + 
  theme(legend.position = "none") + 
  labs(x = "Total Pay & Benefits",
       y = "University System")
```

---

class: middle

.large[**Generating a permuted resample**]

--

.large[__Step 1:__ `specify()` your response and explanatory variables] 

--

.large[__Step 2:__ `hypothesize()` what would happen under the null]

--

.large[__Step 3:__ `generate()` permuted resamples]

--

.large[__Step 4:__ `calculate()` the statistic of interest]


---

class: center

.larger[Declare your variables!]

```{r specify, echo = FALSE, eval = FALSE}
coaches %>% 
  specify(response = `Total Pay & Benefits`,
          explanatory = Agency)
```

```{r}
decorate_chunk("specify", eval = FALSE, echo = TRUE) %>% 
  flair(pattern = "specify")
```


---

class: center

.larger[State your hypothesis!]

```{r hypothesize, echo = FALSE, eval = FALSE}

coaches %>% 
  specify(response = `Total Pay & Benefits`, 
          explanatory = Agency) %>% 
  hypothesize(null = "independence")
```

```{r}
decorate_chunk("hypothesize", eval = FALSE, echo = TRUE) %>% 
  flair(pattern = "hypothesize") %>% 
  flair(pattern = '"independence"', color = "purple")
```

--

.large[`r flair('"independence"', pattern = '"independence"', color = "purple")` -- the assumed relationship between the explanatory and response variables under the null hypothesis]

---

class: center

.larger[Generate your resamples!]

```{r generate, echo = FALSE, eval = FALSE}
coaches %>% 
  specify(response = `Total Pay & Benefits`,
          explanatory = Agency) %>% 
  hypothesize(null = "independence") %>% 
  generate(reps = 1000, type = "permute")
```

```{r}
decorate_chunk("generate", eval = FALSE, echo = TRUE) %>% 
  flair(pattern = "generate") %>% 
  flair(pattern = "reps", color = "pink") %>% 
  flair(pattern = '"permute"', color = "purple")
```

--

.pull-left[
.large[`r flair("reps", pattern = "reps", color = "pink")` -- the number of resamples you want to generate]
]

.pull-right[
.large[`r flair('"permute"', pattern = '"permute"', color = "purple")` -- the method that should be used to generate the new samples]
]

---

class: center, middle

.larger[infer will let you know if you missed something!]

```{r, eval = FALSE, echo = TRUE}
coaches %>% 
  specify(response = `Total Pay & Benefits`, explanatory = Agency) %>% 
  generate(reps = 1000, type = "permute")
```

```
Error: Permuting should be done only when doing independence hypothesis test. See `hypothesize()`.
In addition: Warning message:
You have given `type = "permute"`, but `type` is expected to be `"bootstrap"`.
This workflow is untested and the results may not mean what you think they mean. 
```

---

class: center

.larger[Calculate your statistics!]

<center> 

$\vdots$

</center> 

```{r calculate, echo = FALSE, eval = FALSE}
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in medians", 
            order = c("University of California", "California State University")
            )
```

```{r}
decorate_chunk("calculate", eval = FALSE, echo = TRUE) %>% 
  flair(pattern = "calculate") %>% 
  flair(pattern = '"diff in medians"', color = "purple") %>% 
  flair(pattern = "order", color = "pink")
```

--

.pull-left[
.large[`r flair('"diff in medians"', pattern = '"diff in medians"', color = "purple")` -- the `stat`istic of interest]]

.pull-right[
.large[`r flair('order', pattern = 'order', color = "pink")` -- the order of subtraction that should be used]
]

---

class: middle, center

.larger[Your turn!]

.large[When creating a null distribution, what are the sequence of functions you use?] 

.large[Why is the `hypothesize()` function used to make a null distribution but not 
for a bootstrap distribution?]

.large[What does the `null = "independence"` input in `hypothesize()` mean? What is 
it assuming about the variables declared in the `specify()` step?]

---

class: center, middle, inverse

.larger[The final product]

```{r, out.width = "70%"}
null %>% 
  ggplot(mapping = aes(x = stat)) +
  geom_histogram(binwidth = 9000, color = "white") + 
  labs(title = "", 
       x = "Difference in Median Salary -- UC - CSU")
```

---

class: center 

.larger[Is our observed statistic unlikely under the null?] 

</br> 

--

.large[__Step 1:__ Calculate observed statistic]

.large[__Step 2:__ Find observed statistic on permutation distribution]


---

class: center

.larger[Finding the observed statistic]

```{r obs-stat, echo = FALSE}
diff_median <- coaches %>% 
  specify(response = `Total Pay & Benefits`,
          explanatory = Agency) %>% 
  calculate(stat = "diff in medians", 
            order = c("University of California", "California State University")
            )
```

```{r}
decorate_chunk("obs-stat", eval = FALSE, echo = TRUE) %>% 
  flair(pattern = "specify", color = "purple") %>% 
  flair(pattern = "calculate", color = "pink")
```


---

class: center

```{r, echo = FALSE}
visualise(null) +
  shade_p_value(obs_stat = obs_stat, direction = "both") +
  labs(title = "", 
       x = "Difference in Median Salary -- UC - CSU")
```

--

.large[__Is our observed statistic unlikely to have happened under the null
hypothesis?__]

---

class: center, middle, inverse

.larger[The p-value is...]

```{r, echo = TRUE, message = TRUE, warning = TRUE}
get_p_value(null, obs_stat = diff_median, direction = "both") 
```

---

class: middle, center

.larger[How do we interpret a p-value?]

--

> "The probability of observing a difference in median salaries as or more
> extreme than what was observed is approximately 0.2%, if there was no
> relationship between university system and salary. 


---

class: middle, inverse

.larger[Classic interpretation mistakes]

</br> 

> "The probability that the null hypothesis is true is about 0%." 

</br>
--

</br>

> "The probability that the data were produced by random chance alone is about 0%." 

---

class: inverse, center, middle

.larger[.mango[Exit ticket]]

.large[Suppose we obtained a p-value of 0.6.]

</br>

.larger[How would we interpret this value?]
